{% extends "base.html" %}
{% load static %}
{% block title %}Reproductor: {{ match.home_team }} vs {{ match.away_team }}{% endblock %}

{% block content %}
<div>
  <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">{{ match.home_team }} vs. {{ match.away_team }}</h1>

  <!-- Layout 25%/75% horizontal, panel a la izquierda -->
  <div class="flex flex-col lg:flex-row gap-8 w-full">
    <!-- Panel de control: 25% -->
    <div class="flex flex-col gap-6 lg:basis-1/4 min-w-[320px] max-w-[480px] w-full">
      <!-- Filtros -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Filtros</h2>
        <form method="GET" action="" class="space-y-3">
          <select name="equipo" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="" {% if not filter_params.equipo %}selected{% endif %}>-- Por Equipo --</option>
            {% for option in equipo_options %}{% if option %}<option value="{{ option }}" {% if option == filter_params.equipo %}selected{% endif %}>{{ option }}</option>{% endif %}{% endfor %}
          </select>
          <!-- Reemplazo: Situación -> Jugada -->
          <select name="jugada" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">-- Jugada --</option>
            {% for option in jugada_options %}{% if option %}<option value="{{ option }}" {% if option == filter_params.jugada %}selected{% endif %}>{{ option }}</option>{% endif %}{% endfor %}
          </select>
          <select name="zona_inicio" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">-- Zona Inicio --</option>
            {% for option in zona_inicio_options %}{% if option %}<option value="{{ option }}" {% if option == filter_params.zona_inicio %}selected{% endif %}>{{ option }}</option>{% endif %}{% endfor %}
          </select>
          <select name="zona_fin" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">-- Zona Fin --</option>
            {% for option in zona_fin_options %}{% if option %}<option value="{{ option }}" {% if option == filter_params.zona_fin %}selected{% endif %}>{{ option }}</option>{% endif %}{% endfor %}
          </select>
          <div class="flex space-x-2">
            <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5">Filtrar</button>
            <a href="{% url 'player:play_match' pk=match.pk %}" class="w-full text-center text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700">Limpiar</a>
          </div>
        </form>
      </div>

      <!-- Controles -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Controles</h2>
        <div class="flex flex-col gap-2 mb-3">
          <button id="play-selection-btn" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5 disabled:opacity-50 disabled:cursor-not-allowed" disabled>▶️ Reproducir Selección</button>
          <div class="flex flex-row gap-2">
            <button id="export-filters-btn" type="button" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5">⬇️ Exportar filtradas</button>
            <button id="export-selected-btn" type="button" disabled class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5 disabled:opacity-50 disabled:cursor-not-allowed">⬇️ Exportar seleccionadas</button>
          </div>

          <!-- Nuevo: Deshacer Selección (borra selección en memoria solo en esta vista) -->
          <div class="mt-3">
            <button id="clear-selection-btn" type="button" class="w-full text-gray-900 bg-gray-200 hover:bg-gray-300 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5">⟲ Deshacer Selección</button>
          </div>
        </div>
      </div>

      <!-- INICIO: Presets de selección (movido a la columna izquierda) -->
      <div id="presets-panel" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Presets de selección</h2>
        <div class="space-y-2">
          <select id="preset-select" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2 text-sm">
            <option value="" selected>Elegí un preset…</option>
          </select>
          <div class="flex gap-2">
            <button id="preset-load-btn" class="flex-1 text-white bg-blue-700 hover:bg-blue-800 rounded-lg text-sm px-3 py-2 disabled:opacity-50" disabled>Cargar</button>
            <button id="preset-delete-btn" class="text-white bg-red-600 hover:bg-red-700 rounded-lg text-sm px-3 py-2 disabled:opacity-50" disabled>Eliminar</button>
          </div>
          <button id="preset-save-btn" class="w-full text-gray-900 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm px-3 py-2">Guardar selección como…</button>
        </div>
      </div>
      <!-- FIN: Presets de selección -->

      <!-- NUEVO: Cargar/Actualizar CSV (solo si no hay jugadas y el usuario está autorizado) -->
      {% if can_upload_csv_on_match %}
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Actualizar Jugadas (CSV)</h2>
        <form method="post" action="{% url 'player:upload_csv_match' pk=match.pk %}" enctype="multipart/form-data" class="flex items-center gap-2">
          {% csrf_token %}
          <input type="file" name="csv_file" accept=".csv" class="flex-1 text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600" required>
          <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-4 py-2">Subir</button>
        </form>
        <p class="text-xs text-gray-500 mt-2">Admite UTF-8/Latin-1/Windows-1252. Antes de subir revisá la preview si aparece.</p>
      </div>
      {% endif %}

      <!-- Tabla -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 overflow-x-auto">
        <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Lista de Jugadas</h2>
        <table id="plays-table" class="min-w-full text-sm text-left text-gray-500 dark:text-gray-400 display nowrap" style="width:100%">
          <thead class="text-xs uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
            <tr>
              <th class="p-2"><input type="checkbox" id="dt-select-all"></th>
              <th class="p-2">Equipo</th>
              <th class="p-2">Jugada</th>
              <th class="p-2">Zona Inicio</th>
              <th class="p-2">Zona Fin</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Columna derecha: video (75%) -->
    <div class="video-container flex-1 lg:basis-3/4" style="min-width:0;">
      <div id="player" data-video-id="{{ match.video_id }}" class="w-full h-[480px] bg-black rounded-lg"></div>
      <!-- Panel Ahora Reproduciendo -->
      <div id="now-playing-panel" class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 hidden">
        <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Ahora reproduciendo</div>
        <div id="now-playing-event" class="text-base font-semibold text-gray-900 dark:text-white mt-1">---</div>
        <div id="now-playing-details" class="text-sm text-gray-600 dark:text-gray-300">Seleccioná jugadas y presioná play</div>
      </div>
    </div>
  </div>
</div>

{% if messages %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
      Swal.fire({
        icon: '{{ message.tags|default:"info" }}',
        title: '{{ message|escapejs }}',
        showConfirmButton: false,
        timer: 2500
      });
    {% endfor %}
  });
</script>
{% endif %}

{% block scripts %}
<script>
  // DataTables + selección en memoria (solo mientras permanezcas en esta vista)
  (function(){
    function waitForDT(cb, tries=20){
      if (window.DataTable) return cb();
      if (tries<=0) return console.error('DataTables no cargó');
      setTimeout(() => waitForDT(cb, tries-1), 150);
    }

    waitForDT(function(){
      // Persistimos SOLO en memoria. No usamos localStorage.
      let selectedSet = new Set();
      // FIX: Exponer el set de selección en el objeto window para que otros scripts lo vean
      window.selectedSet = selectedSet;

      const exportFiltersBtn = document.getElementById('export-filters-btn');
      const exportSelectedBtn = document.getElementById('export-selected-btn');
      const playBtn = document.getElementById('play-selection-btn');
      const dtSelectAll = document.getElementById('dt-select-all');
      const clearSelectionBtn = document.getElementById('clear-selection-btn');

      const updateButtons = () => {
        if (exportSelectedBtn) exportSelectedBtn.disabled = selectedSet.size === 0;
        if (playBtn) playBtn.disabled = selectedSet.size === 0;
      };
      // FIX: Exponer también la función para que el script de presets la pueda llamar
      window.updateButtons = updateButtons;

      const ajaxUrl = `{% url 'player:plays_data' pk=match.pk %}`;

      const dt = new DataTable('#plays-table', {
        rowId: row => `play-item-${row[0]}`,
        processing: true,
        serverSide: true,
        searching: true,
        lengthChange: true,
        pageLength: 10,
        order: [[1, 'asc']],
        info: false,
        scrollX: true,
        ajax: function(data, callback) {
          const params = new URLSearchParams(window.location.search);
          const payload = new URLSearchParams();
          // DataTables
          payload.set('draw', data.draw);
          payload.set('start', data.start);
          payload.set('length', data.length);
          if (data.search && data.search.value) payload.set('search[value]', data.search.value);
          if (data.order && data.order.length) {
            payload.set('order[0][column]', data.order[0].column);
            payload.set('order[0][dir]', data.order[0].dir);
          }
          // Filtros actuales
          ['equipo','jugada','zona_inicio','zona_fin'].forEach(k => {
            const v = params.get(k);
            if (v) payload.set(k, v);
          });

          fetch(`${ajaxUrl}?${payload.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
            .then(json => { callback(json); })
            .catch(err => {
              console.error('DataTables AJAX error:', err);
              callback({ draw: data.draw, recordsTotal: 0, recordsFiltered: 0, data: [] });
            });
        },
        columns: [
          { data: null, orderable: false, render: function(_data, _type, row){
              const id = row[0];
              const inicio = row[1] ?? '';
              const fin = row[2] ?? '';
              const evento = row[3] ?? '';
              const equipo = row[4] ?? '';
              const checked = selectedSet.has(String(id)) ? 'checked' : '';
              return `<input type="checkbox" class="dt-play" value="${id}" data-start="${inicio}" data-end="${fin}" data-event="${evento}" data-equipo="${equipo}" ${checked}>`;
            }
          },
          { data: 4 },
          { data: 5 },
          { data: 6 },
          { data: 7 },
        ],
        drawCallback: function(){
          const allVisible = Array.from(document.querySelectorAll('#plays-table .dt-play'));
          const allChecked = allVisible.length && allVisible.every(cb => cb.checked);
          if (dtSelectAll) dtSelectAll.checked = allChecked;
        }
      });

      // Cambios en checkboxes por fila
      document.querySelector('#plays-table').addEventListener('change', (e) => {
        if (e.target && e.target.classList.contains('dt-play')) {
          const id = String(e.target.value);
          if (e.target.checked) selectedSet.add(id); else selectedSet.delete(id);
          updateButtons();
        }
      });

      // Seleccionar todo de la página actual
      if (dtSelectAll) {
        dtSelectAll.addEventListener('change', function(){
          const check = this.checked;
          document.querySelectorAll('#plays-table .dt-play').forEach(cb => {
            cb.checked = check;
            const id = String(cb.value);
            if (check) selectedSet.add(id); else selectedSet.delete(id);
          });
          updateButtons();
        });
      }

      // Exportar filtradas (sin ids)
      if (exportFiltersBtn) {
        exportFiltersBtn.addEventListener('click', () => {
          const params = new URLSearchParams(window.location.search);
          params.set('export','csv');
          window.location.href = `${window.location.pathname}?${params.toString()}`;
        });
      }

      // Exportar seleccionadas (con ids)
      if (exportSelectedBtn) {
        exportSelectedBtn.addEventListener('click', () => {
          if (!selectedSet.size) return;
          const params = new URLSearchParams(window.location.search);
          params.set('export','csv');
          params.set('ids', Array.from(selectedSet).join(','));
          window.location.href = `${window.location.pathname}?${params.toString()}`;
        });
      }

      // Deshacer selección
      if (clearSelectionBtn) {
        clearSelectionBtn.addEventListener('click', () => {
          // limpiar set en memoria y desmarcar checkboxes visibles
          selectedSet.clear();
          document.querySelectorAll('#plays-table .dt-play').forEach(cb => cb.checked = false);
          if (dtSelectAll) dtSelectAll.checked = false;
          updateButtons();
          // feedback al usuario
          if (window.Swal) {
            Swal.fire({
              icon: 'info',
              title: 'Selección deshecha',
              timer: 1200,
              showConfirmButton: false
            });
          }
        });
      }

      updateButtons();

      // Limpieza al salir de la página o al volver mediante bfcache
      window.addEventListener('pagehide', () => {
        selectedSet.clear();
      });
      window.addEventListener('pageshow', (e) => {
        if (e.persisted) {
          selectedSet.clear();
          document.querySelectorAll('#plays-table .dt-play').forEach(cb => cb.checked = false);
          if (dtSelectAll) dtSelectAll.checked = false;
          updateButtons();
        }
      });
    });
  })();
</script>
<!-- Script de presets (usa window.selectedSet y window.updateButtons) -->
<script>
  (function(){
    // Esperar a que el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
      function getCookie(name) {
        const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return parts.pop().split(';').shift();
      }
      const csrftoken = getCookie('csrftoken');
      const matchId = {{ match.id }};

      const presetSelect = document.getElementById('preset-select');
      const btnLoad = document.getElementById('preset-load-btn');
      const btnDelete = document.getElementById('preset-delete-btn');
      const btnSave = document.getElementById('preset-save-btn');

      function toast(icon, title, timer=1400) {
        if (window.Swal) Swal.fire({icon, title, timer, showConfirmButton:false}); else console.log(icon, title);
      }

      function togglePresetActions() {
        const hasSel = !!(presetSelect && presetSelect.value);
        if (btnLoad) btnLoad.disabled = !hasSel;
        if (btnDelete) btnDelete.disabled = !hasSel;
      }

      async function refreshPresets() {
        try {
          const res = await fetch(`/matches/${matchId}/presets/`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
          if (!res.ok) throw new Error('Error al cargar presets');
          const data = await res.json();
          if (!presetSelect) return;
          presetSelect.innerHTML = '<option value="">Elegí un preset…</option>';
          (data.presets || []).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id; opt.textContent = p.name;
            presetSelect.appendChild(opt);
          });
          togglePresetActions();
        } catch (e) { console.error(e); }
      }

      if (presetSelect) presetSelect.addEventListener('change', togglePresetActions);

      if (btnSave) btnSave.addEventListener('click', async () => {
        const name = prompt('Nombre del preset:');
        if (!name || !name.trim()) return;
        const ids = Array.from((window.selectedSet||new Set())).map(x => parseInt(x,10)).filter(n => !isNaN(n));
        if (!ids.length) return toast('warning','No hay jugadas seleccionadas para guardar.');
        try {
          const res = await fetch(`/matches/${matchId}/presets/`, {
            method: 'POST',
            headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'},
            body: JSON.stringify({name: name.trim(), play_ids: ids})
          });
          if (!res.ok) throw new Error(await res.text());
          await refreshPresets();
          toast('success','Preset guardado');
        } catch(e){ console.error(e); toast('error','No se pudo guardar el preset'); }
      });

      if (btnLoad) btnLoad.addEventListener('click', async () => {
        const id = presetSelect && presetSelect.value;
        if (!id) return;
        try {
          const res = await fetch(`/matches/${matchId}/presets/${id}/`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
          if (!res.ok) throw new Error('Error al cargar preset');
          const data = await res.json();
          const ids = (data.play_ids||[]).map(String);
          // FIX: Usar la variable global directamente
          const sel = window.selectedSet;
          if (!sel) {
            console.error('window.selectedSet no está definido');
            return;
          }
          sel.clear(); 
          ids.forEach(i => sel.add(i));
          document.querySelectorAll('#plays-table input.dt-play').forEach(cb => {
            const pid = (cb.value||'').toString(); cb.checked = sel.has(pid);
          });
          // FIX: Llamar a la función global
          if (typeof window.updateButtons === 'function') window.updateButtons();
          toast('success','Preset cargado en la selección');
        } catch(e){ console.error(e); toast('error','No se pudo cargar el preset'); }
      });

      if (btnDelete) btnDelete.addEventListener('click', async () => {
        const id = presetSelect && presetSelect.value;
        if (!id) return;
        if (!confirm('¿Estás seguro de que querés eliminar este preset?')) return;
        try {
          const res = await fetch(`/matches/${matchId}/presets/${id}/`, { method:'DELETE', headers:{'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'} });
          if (!res.ok) throw new Error(await res.text());
          await refreshPresets();
          toast('success','Preset eliminado');
        } catch(e){ console.error(e); toast('error','No se pudo eliminar el preset'); }
      });

      // Carga inicial
      refreshPresets();
    });
  })();
</script>

<!-- FIX: Volver a agregar el script del reproductor de video -->
<script src="{% static 'js/player.js' %}"></script>

{% endblock %}

{% endblock %}
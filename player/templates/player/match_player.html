{% extends "base.html" %}
{% load static %}
{% block title %}Reproductor: {{ match.home_team }} vs {{ match.away_team }}{% endblock %}

{% block content %}
<div>
  <h1 class="text-3xl font-bold mb-6 text-gray-900 dark:text-white">{{ match.home_team }} vs. {{ match.away_team }}</h1>

  <!-- Layout 25%/75% horizontal, panel a la izquierda -->
  <div class="flex flex-col lg:flex-row gap-8 w-full">
    <!-- Panel 25% (Filtros, Controles, Presets, CSV) -->
    <div class="flex flex-col gap-6 lg:basis-1/4 min-w-[320px] max-w-[480px] w-full">
      <!-- Filtros -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Filtros</h2>
        <form method="GET" action="" class="space-y-3">
          <select name="equipo" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="" {% if not filter_params.equipo %}selected{% endif %}>-- Por Equipo --</option>
            {% for option in equipo_options %}{% if option %}<option value="{{ option }}" {% if option == filter_params.equipo %}selected{% endif %}>{{ option }}</option>{% endif %}{% endfor %}
          </select>
          <!-- Reemplazo: Situación -> Jugada -->
          <select name="jugada" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">-- Jugada --</option>
            {% for option in jugada_options %}{% if option %}<option value="{{ option }}" {% if option == filter_params.jugada %}selected{% endif %}>{{ option }}</option>{% endif %}{% endfor %}
          </select>
          <select name="zona_inicio" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">-- Zona Inicio --</option>
            {% for option in zona_inicio_options %}{% if option %}<option value="{{ option }}" {% if option == filter_params.zona_inicio %}selected{% endif %}>{{ option }}</option>{% endif %}{% endfor %}
          </select>
          <select name="zona_fin" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <option value="">-- Zona Fin --</option>
            {% for option in zona_fin_options %}{% if option %}<option value="{{ option }}" {% if option == filter_params.zona_fin %}selected{% endif %}>{{ option }}</option>{% endif %}{% endfor %}
          </select>
          <div class="flex space-x-2">
            <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5">Filtrar</button>
            <a href="{% url 'player:play_match' pk=match.pk %}" class="w-full text-center text-gray-900 bg-white border border-gray-300 hover:bg-gray-100 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700">Limpiar</a>
          </div>
        </form>
      </div>

      <!-- Controles -->
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Controles</h2>
        <div class="flex flex-col gap-2 mb-3">
          <button id="play-selection-btn" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5 disabled:opacity-50 disabled:cursor-not-allowed" disabled>▶️ Reproducir Selección</button>
          <div class="flex flex-row gap-2">
            <button id="export-filters-btn" type="button" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5">⬇️ Exportar filtradas</button>
            <button id="export-selected-btn" type="button" disabled class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5 disabled:opacity-50 disabled:cursor-not-allowed">⬇️ Exportar seleccionadas</button>
          </div>

          <!-- Nuevo: Deshacer Selección (borra selección en memoria solo en esta vista) -->
          <div class="mt-3">
            <button id="clear-selection-btn" type="button" class="w-full text-gray-900 bg-gray-200 hover:bg-gray-300 focus:ring-4 font-medium rounded-lg text-sm px-5 py-2.5">⟲ Deshacer Selección</button>
          </div>
        </div>
      </div>

      <!-- INICIO: Presets de selección (movido a la columna izquierda) -->
      <div id="presets-panel" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Presets de selección</h2>
        <div class="space-y-2">
          <select id="preset-select" class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2 text-sm">
            <option value="" selected>Elegí un preset…</option>
          </select>
          <div class="flex gap-2">
            <button id="preset-load-btn" class="flex-1 text-white bg-blue-700 hover:bg-blue-800 rounded-lg text-sm px-3 py-2 disabled:opacity-50" disabled>Cargar</button>
            <button id="preset-delete-btn" class="text-white bg-red-600 hover:bg-red-700 rounded-lg text-sm px-3 py-2 disabled:opacity-50" disabled>Eliminar</button>
          </div>
          <button id="preset-save-btn" class="w-full text-gray-900 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm px-3 py-2">Guardar selección como…</button>
        </div>
      </div>
      <!-- FIN: Presets de selección -->

      <!-- NUEVO: Cargar/Actualizar CSV (solo si no hay jugadas y el usuario está autorizado) -->
      {% if can_upload_csv_on_match %}
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
        <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Actualizar Jugadas (CSV)</h2>
        <form method="post" action="{% url 'player:upload_csv_match' pk=match.pk %}" enctype="multipart/form-data" class="flex items-center gap-2">
          {% csrf_token %}
          <input type="file" name="csv_file" accept=".csv" class="flex-1 text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600" required>
          <button type="submit" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 font-medium rounded-lg text-sm px-4 py-2">Subir</button>
        </form>
        <p class="text-xs text-gray-500 mt-2">Admite UTF-8/Latin-1/Windows-1252. Antes de subir revisá la preview si aparece.</p>
      </div>
      {% endif %}
    </div>

    <!-- Columna derecha: video (75%) -->
    <div class="video-container flex-1 lg:basis-3/4" style="min-width:0;">
      <div id="player" data-video-id="{{ match.video_id }}" class="w-full h-[480px] bg-black rounded-lg"></div>
      <!-- Panel Ahora Reproduciendo -->
      <div id="now-playing-panel" class="mt-4 bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 hidden">
        <div class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Ahora reproduciendo</div>
        <div id="now-playing-event" class="text-base font-semibold text-gray-900 dark:text-white mt-1">---</div>
        <div id="now-playing-details" class="text-sm text-gray-600 dark:text-gray-300">Seleccioná jugadas y presioná play</div>
      </div>
    </div>
  </div>

  <!-- Grid inferior (50%/50%): DataTable a la izquierda -->
  <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 50% izquierdo: Lista de Jugadas -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 overflow-x-auto">
      <h2 class="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Lista de Jugadas</h2>
      <!-- Agrego clases para evitar colapso y habilitar scroll horizontal -->
      <table id="plays-table" class="min-w-full min-w-max whitespace-nowrap text-sm text-left text-gray-500 dark:text-gray-400 display nowrap" style="width:100%">
        <thead class="text-xs uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
          <tr>
            <th class="p-2"><input type="checkbox" id="dt-select-all"></th>
            <th class="p-2">Jugada</th>
            <th class="p-2">Equipo</th>
            <th class="p-2">Inicia</th>
            <th class="p-2">Zona Inicio</th>
            <th class="p-2">Termina</th>
            <th class="p-2">Zona Fin</th>
            <th class="p-2">Resultado</th>
            <th class="p-2">Sanción</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- 50% derecho: espacio para futuras tarjetas (estadísticas, notas, etc.) -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 min-h-[200px]">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Selección actual</h2>
        <span id="selected-count" class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200">0</span>
      </div>
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Jugadas que marcaste (se usan para Reproducir Selección y para guardar Preset).</p>
      <ul id="selected-plays-list" class="mt-3 divide-y divide-gray-200 dark:divide-gray-700"></ul>
    </div>
  </div>
</div>

{% if messages %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
      Swal.fire({
        icon: '{{ message.tags|default:"info" }}',
        title: '{{ message|escapejs }}',
        showConfirmButton: false,
        timer: 2500
      });
    {% endfor %}
  });
</script>
{% endif %}

{% block scripts %}
<script>
  (function(){
    function waitForDT(cb, tries=20){
      if (window.DataTable) return cb();
      if (tries<=0) return console.error('DataTables no cargó');
      setTimeout(() => waitForDT(cb, tries-1), 150);
    }

    waitForDT(function(){
      let selectedSet = new Set();
      window.selectedSet = selectedSet;

      const exportFiltersBtn = document.getElementById('export-filters-btn');
      const exportSelectedBtn = document.getElementById('export-selected-btn');
      const playBtn = document.getElementById('play-selection-btn');
      const dtSelectAll = document.getElementById('dt-select-all');
      const clearSelectionBtn = document.getElementById('clear-selection-btn');

      const selectedListEl = document.getElementById('selected-plays-list');
      const selectedCountEl = document.getElementById('selected-count');
      const matchId = {{ match.id }};
      const apiPlaysUrl = `/api/matches/${matchId}/plays/`;

      // Índices de columnas del backend (ajusta aquí si tu endpoint cambia)
      const IDX = {
        id: 0,
        inicio: 1,       // "INICIA" (timestamp)
        fin: 2,          // "TERMINA" (timestamp)
        evento: 3,       // evento (fallback si no hay jugada)
        equipo: 4,       // EQUIPO
        jugada: 5,       // JUGADA
        zona_inicio: 6,  // ZONA INICIO
        zona_fin: 7,     // ZONA FIN
        resultado: 8,    // RESULTADO
        sancion: 9       // SANCION
      };

      // Caché de metadatos por id (id -> {id, equipo, evento/jugada, inicio, fin})
      const playMetaCache = (window.playMetaCache = window.playMetaCache || new Map());

      const updateButtons = () => {
        if (exportSelectedBtn) exportSelectedBtn.disabled = selectedSet.size === 0;
        if (playBtn) playBtn.disabled = selectedSet.size === 0;
      };
      window.updateButtons = updateButtons;

      async function renderSelectedList() {
        if (!selectedListEl || !selectedCountEl) return;
        const ids = Array.from(selectedSet).map(String);
        selectedCountEl.textContent = ids.length.toString();

        const missing = ids.filter(id => !playMetaCache.has(id));
        if (missing.length) {
          try {
            const res = await fetch(`${apiPlaysUrl}?ids=${missing.join(',')}`, { headers: { 'X-Requested-With':'XMLHttpRequest' }});
            if (res.ok) {
              const arr = await res.json();
              arr.forEach(p => {
                playMetaCache.set(String(p.id), {
                  id: p.id,
                  equipo: p.equipo || '',
                  evento: p.evento || p.jugada || '',
                  inicio: p.inicio ?? '',
                  fin: p.fin ?? ''
                });
              });
            }
          } catch(e) { console.warn('No se pudieron cargar metadatos de jugadas faltantes', e); }
        }

        selectedListEl.innerHTML = '';
        ids.forEach(id => {
          const meta = playMetaCache.get(id) || { id, equipo: '', evento: '', inicio: '', fin: '' };
          const li = document.createElement('li');
          li.className = 'py-2 flex items-center justify-between';
          li.innerHTML = `
  <div class="min-w-0">
    <div class="text-sm text-gray-900 dark:text-white truncate">
      <span class="font-medium">${meta.equipo || '—'}</span>
      <span class="mx-1 text-gray-400">·</span>
      <span>${meta.evento || 'Jugada'}</span>
    </div>
    <div class="text-xs text-gray-500 dark:text-gray-400">[${meta.inicio || ''} - ${meta.fin || ''}]</div>
  </div>
  <div class="flex items-center gap-2">
    <button data-id="${id}" class="remove-play text-xs px-2 py-1 rounded text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-800 transition-colors">Quitar</button>
  </div>
`;
          selectedListEl.appendChild(li);
        });

        selectedListEl.querySelectorAll('button.remove-play').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = String(e.currentTarget.getAttribute('data-id'));
            selectedSet.delete(id);
            document.querySelectorAll(`#plays-table .dt-play[value="${id}"]`).forEach(cb => cb.checked = false);
            if (dtSelectAll) dtSelectAll.checked = false;
            updateButtons();
            renderSelectedList();
          });
        });
      }

      const ajaxUrl = `{% url 'player:plays_data' pk=match.pk %}`;

      const dt = new DataTable('#plays-table', {
        rowId: row => `play-item-${row[IDX.id]}`,
        processing: true,
        serverSide: true,
        searching: true,
        lengthChange: true,
        pageLength: 10,
  // Ordenar por la columna visible "Inicia" (índice visible 3)
  order: [[3, 'asc']],
        info: false,
        scrollX: true,                  // scrollbar horizontal de DataTables
        autoWidth: false,               // evitá que calcule widths raros
        ajax: function(data, callback) {
          const params = new URLSearchParams(window.location.search);
          const payload = new URLSearchParams();
          payload.set('draw', data.draw);
          payload.set('start', data.start);
          payload.set('length', data.length);
          if (data.search && data.search.value) payload.set('search[value]', data.search.value);
          if (data.order && data.order.length) {
            payload.set('order[0][column]', data.order[0].column);
            payload.set('order[0][dir]', data.order[0].dir);
          }
          ['equipo','jugada','zona_inicio','zona_fin'].forEach(k => {
            const v = params.get(k);
            if (v) payload.set(k, v);
          });

          fetch(`${ajaxUrl}?${payload.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
            .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
            .then(json => { callback(json); })
            .catch(err => {
              console.error('DataTables AJAX error:', err);
              callback({ draw: data.draw, recordsTotal: 0, recordsFiltered: 0, data: [] });
            });
        },
        columns: [
          // Selección
          { data: null, orderable: false, width: '42px', render: function(_data, _type, row){
              const id = row[IDX.id];
              const inicio = row[IDX.inicio] ?? '';
              const fin = row[IDX.fin] ?? '';
              const equipo = row[IDX.equipo] ?? '';
              const jugada = row[IDX.jugada] ?? row[IDX.evento] ?? '';
              const checked = selectedSet.has(String(id)) ? 'checked' : '';
              // Cache para el panel de selección
              playMetaCache.set(String(id), { id, equipo, evento: jugada, inicio, fin });
              return `<input type="checkbox" class="dt-play" value="${id}" data-start="${inicio}" data-end="${fin}" data-event="${jugada}" data-equipo="${equipo}" ${checked}>`;
            }
          },
          // Orden requerido: JUGADA, EQUIPO, INICIA, ZONA INICIO, TERMINA, ZONA FIN, RESULTADO, SANCION
          { data: IDX.jugada,   title: 'Jugada',      defaultContent: '' },
          { data: IDX.equipo,   title: 'Equipo',      defaultContent: '' },
          { data: IDX.inicio,   title: 'Inicia',      defaultContent: '' },
          { data: IDX.zona_inicio, title: 'Zona Inicio', defaultContent: '' },
          { data: IDX.fin,      title: 'Termina',     defaultContent: '' },
          { data: IDX.zona_fin, title: 'Zona Fin',    defaultContent: '' },
          { data: IDX.resultado, title: 'Resultado',  defaultContent: '' },
          { data: IDX.sancion,  title: 'Sanción',     defaultContent: '' },
        ],
        drawCallback: function(){
          const allVisible = Array.from(document.querySelectorAll('#plays-table .dt-play'));
          const allChecked = allVisible.length && allVisible.every(cb => cb.checked);
          if (dtSelectAll) dtSelectAll.checked = allChecked;
          renderSelectedList();
        }
      });

      // Resto: listeners (sin cambios)
      document.querySelector('#plays-table').addEventListener('change', (e) => {
        if (e.target && e.target.classList.contains('dt-play')) {
          const id = String(e.target.value);
          if (e.target.checked) selectedSet.add(id); else selectedSet.delete(id);
          if (!playMetaCache.has(id)) {
            playMetaCache.set(id, {
              id,
              equipo: e.target.dataset.equipo || '',
              evento: e.target.dataset.event || '',
              inicio: e.target.dataset.start || '',
              fin: e.target.dataset.end || ''
            });
          }
          updateButtons();
          renderSelectedList();
        }
      });

      if (dtSelectAll) {
        dtSelectAll.addEventListener('change', function(){
          const check = this.checked;
          document.querySelectorAll('#plays-table .dt-play').forEach(cb => {
            cb.checked = check;
            const id = String(cb.value);
            if (check) selectedSet.add(id); else selectedSet.delete(id);
            if (!playMetaCache.has(id)) {
              playMetaCache.set(id, {
                id,
                equipo: cb.dataset.equipo || '',
                evento: cb.dataset.event || '',
                inicio: cb.dataset.start || '',
                fin: cb.dataset.end || ''
              });
            }
          });
          updateButtons();
          renderSelectedList();
        });
      }

      // Botones y limpiezas (sin cambios)
      // ...
      updateButtons();
      renderSelectedList();
      window.renderSelectedList = renderSelectedList;
    });
  })();
</script>
<!-- presets script y player.js se mantienen -->
<script>
  (function(){
    // Esperar a que el DOM esté listo
    document.addEventListener('DOMContentLoaded', function() {
      function getCookie(name) {
        const value = `; ${document.cookie}`; const parts = value.split(`; ${name}=`); if (parts.length === 2) return parts.pop().split(';').shift();
      }
      const csrftoken = getCookie('csrftoken');
      const matchId = {{ match.id }};

      const presetSelect = document.getElementById('preset-select');
      const btnLoad = document.getElementById('preset-load-btn');
      const btnDelete = document.getElementById('preset-delete-btn');
      const btnSave = document.getElementById('preset-save-btn');

      function toast(icon, title, timer=1400) {
        if (window.Swal) Swal.fire({icon, title, timer, showConfirmButton:false}); else console.log(icon, title);
      }

      function togglePresetActions() {
        const hasSel = !!(presetSelect && presetSelect.value);
        if (btnLoad) btnLoad.disabled = !hasSel;
        if (btnDelete) btnDelete.disabled = !hasSel;
      }

      async function refreshPresets() {
        try {
          const res = await fetch(`/matches/${matchId}/presets/`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
          if (!res.ok) throw new Error('Error al cargar presets');
          const data = await res.json();
          if (!presetSelect) return;
          presetSelect.innerHTML = '<option value="">Elegí un preset…</option>';
          (data.presets || []).forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.id; opt.textContent = p.name;
            presetSelect.appendChild(opt);
          });
          togglePresetActions();
        } catch (e) { console.error(e); }
      }

      if (presetSelect) presetSelect.addEventListener('change', togglePresetActions);

      if (btnSave) btnSave.addEventListener('click', async () => {
        const name = prompt('Nombre del preset:');
        if (!name || !name.trim()) return;
        const ids = Array.from((window.selectedSet||new Set())).map(x => parseInt(x,10)).filter(n => !isNaN(n));
        if (!ids.length) return toast('warning','No hay jugadas seleccionadas para guardar.');
        try {
          const res = await fetch(`/matches/${matchId}/presets/`, {
            method: 'POST',
            headers: {'Content-Type':'application/json','X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'},
            body: JSON.stringify({name: name.trim(), play_ids: ids})
          });
          if (!res.ok) throw new Error(await res.text());
          await refreshPresets();
          toast('success','Preset guardado');
        } catch(e){ console.error(e); toast('error','No se pudo guardar el preset'); }
      });

      if (btnLoad) btnLoad.addEventListener('click', async () => {
        const id = presetSelect && presetSelect.value;
        if (!id) return;
        try {
          const res = await fetch(`/matches/${matchId}/presets/${id}/`, {headers:{'X-Requested-With':'XMLHttpRequest'}});
          if (!res.ok) throw new Error('Error al cargar preset');
          const data = await res.json();
          const ids = (data.play_ids||[]).map(String);
          const sel = window.selectedSet;
          if (!sel) return;
          sel.clear();
          ids.forEach(i => sel.add(i));
          document.querySelectorAll('#plays-table input.dt-play').forEach(cb => {
            const pid = (cb.value||'').toString(); cb.checked = sel.has(pid);
          });
          if (typeof window.updateButtons === 'function') window.updateButtons();
          if (typeof window.renderSelectedList === 'function') window.renderSelectedList();  // <-- agregar
          toast('success','Preset cargado en la selección');
        } catch(e){ console.error(e); toast('error','No se pudo cargar el preset'); }
      });

      if (btnDelete) btnDelete.addEventListener('click', async () => {
        const id = presetSelect && presetSelect.value;
        if (!id) return;
        if (!confirm('¿Estás seguro de que querés eliminar este preset?')) return;
        try {
          const res = await fetch(`/matches/${matchId}/presets/${id}/`, { method:'DELETE', headers:{'X-CSRFToken': csrftoken, 'X-Requested-With':'XMLHttpRequest'} });
          if (!res.ok) throw new Error(await res.text());
          await refreshPresets();
          toast('success','Preset eliminado');
        } catch(e){ console.error(e); toast('error','No se pudo eliminar el preset'); }
      });

      // Carga inicial
      refreshPresets();
    });
  })();
</script>

<!-- FIX: Volver a agregar el script del reproductor de video -->
<script src="{% static 'js/player.js' %}"></script>

{% endblock %}

{% endblock %}